<!DOCTYPE html>
<html>
    <head/>
    <body>
        <video autoplay></video>
        <canvas></canvas>
        <form><button onclick='capture(); return false;'>Hello</button></form>
        <div id='matches'></div>
        <script>
            var global_thing;
            function capture() {
                console.log('Capturing!');

                // Set the "screenshot" canvas to the size of the video
                var video = document.querySelector('video');
                var canvas = document.querySelector('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Use a 2-dimensional context (flat image, not 3D)
                var context = canvas.getContext('2d');

                // Transfer the still from the video to the canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // The data in the cavas as a string
                var data_url = canvas.toDataURL()

                send({'image_uri': data_url});
            }

            // https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Sending_forms_through_JavaScript#Sending_form_data
            function send(data) {
                var xhttp = new XMLHttpRequest();
                xhttp.addEventListener('load', got_response);
                xhttp.addEventListener('error', error);

                var urlEncodedDataPairs = [];
                for (var key in data) {
                    var value = data[key];
                    var encoded_key = encodeURIComponent(key);
                    var encoded_value = encodeURIComponent(value)
                    urlEncodedDataPairs.push(encoded_key + '=' + encoded_value);
                }
                urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

                xhttp.open('POST', 'process', true);
                xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhttp.send(urlEncodedData);
            }

            function got_response(response) {
                console.log(response);
                var results = JSON.parse(response.target.responseText);
                console.log(results);
                for (var i = 0; i < results.length; i++) {
                    var result = results[i];
                    render_overlay(result);
                }
            }

            function render_overlay(result) {
                var landmarks = result[0];
                var twins = result[1];
                var position = result[2];

                var canvas = document.querySelector('canvas');
                var context = canvas.getContext('2d');

                // Draw face outline
                context.strokeStyle = 'red';
                context.lineWidth = 4;
                context.strokeRect(
                    position['x'],
                    position['y'],
                    position['width'],
                    position['height'],
                );

                // Draw landmarks over face
                for (var i = 0; i < landmarks.length; i++) {
                    var landmark = landmarks[i];
                    context.fillStyle = 'blue'
                    context.fillRect(landmark['x'] - 1, landmark['y'] - 1, 3, 3)
                }

                show_matches(twins);
            }

            function show_matches(twins) {
                var matches_div = document.querySelector('#matches');

                // Remove any existing matches
                matches_div.innerHTML = '';

                for (var i = 0; i < twins.length; i++) {
                    var twin = twins[i];
                    twin_content = render_twin(twin);
                    matches_div.appendChild(twin_content);
                }
            }

            function render_twin(twin) {
                global_thing = twin;

                var distance = twin[0];
                var name = twin[1];
                var dsid = twin[2];
                var base64_image = twin[3];

                var div = document.createElement('div');
                div.setAttribute('class', 'twin');
                var img = document.createElement('img');
                img.setAttribute('src', 'data:image/png;base64,' + base64_image);
                div.appendChild(img)

                var link = document.createElement('a');
                link.innerText = name
                link.setAttribute('href', 'adir://employees/' + dsid);
                div.appendChild(link)

                var similarity = document.createElement('span');
                similarity.innerText = ' matches ' + ((1 - distance) * 100).toFixed(2) + '%';
                div.appendChild(similarity);

                return div
            }

            function setup_stream(stream) {
                console.log('Setting up stream')
                var video = document.querySelector('video');
                video.srcObject = stream;
            }

            function error(err) {
                console.log(err);
            }

            navigator.mediaDevices
                .getUserMedia({video: true})
                .then(setup_stream)
                .catch(error)
        </script>
    </body>
</html>